<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Billing System</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Error message styling */
        .error-message {
            color: #e74c3c;
            margin: 10px 0;
            padding: 10px;
            background: #f8d7da;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Customer Billing System</h1>
        <nav>
            <ul>
                <li><a href="#" class="active" data-section="dashboard">Dashboard</a></li>
                <li><a href="#" data-section="customers">Customers</a></li>
                <li><a href="#" data-section="bills">Bills</a></li>
                <li><a href="#" data-section="items">Items</a></li>
                <li><a href="#" data-section="users">Users</a></li>
                <li><button id="logoutBtn">Logout</button></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Error container for API issues -->
        <div id="apiError" class="error-message"></div>
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <h2>Dashboard</h2>
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Total Customers</h3>
                    <p id="totalCustomers">0</p>
                </div>
                <div class="stat-card">
                    <h3>Pending Bills</h3>
                    <p id="pendingBills">0</p>
                </div>
                <div class="stat-card">
                    <h3>Paid Bills</h3>
                    <p id="paidBills">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Revenue</h3>
                    <p id="totalRevenue">$0.00</p>
                </div>
            </div>
            <div class="recent-activity">
                <h3>Recent Activity</h3>
                <div id="activityLog"></div>
            </div>
        </section>

        <!-- Customers Section -->
        <section id="customers" class="content-section">
            <h2>Customer Management</h2>
            <button id="addCustomerBtn" class="btn">Add New Customer</button>
            <div class="search-container">
                <input type="text" id="customerSearch" placeholder="Search customers...">
                <button id="searchCustomerBtn" class="btn">Search</button>
            </div>
            <div id="customerList" class="data-table-container"></div>
        </section>

        <!-- Bills Section -->
        <section id="bills" class="content-section">
            <h2>Bill Management</h2>
            <button id="generateBillBtn" class="btn">Generate New Bill</button>
            <div class="filter-container">
                <select id="billStatusFilter">
                    <option value="all">All Bills</option>
                    <option value="PENDING">Pending</option>
                    <option value="PAID">Paid</option>
                </select>
                <input type="text" id="billSearch" placeholder="Search by account number...">
                <button id="searchBillBtn" class="btn">Search</button>
            </div>
            <div id="billList" class="data-table-container"></div>
        </section>

        <!-- Items Section -->
        <section id="items" class="content-section">
            <h2>Item Management</h2>
            <button id="addItemBtn" class="btn">Add New Item</button>
            <div class="search-container">
                <input type="text" id="itemSearch" placeholder="Search items...">
                <button id="searchItemBtn" class="btn">Search</button>
            </div>
            <div id="itemList" class="data-table-container"></div>
        </section>

        <!-- Users Section -->
        <section id="users" class="content-section">
            <h2>User Management</h2>
            <button id="addUserBtn" class="btn">Add New User</button>
            <div id="userList" class="data-table-container"></div>
        </section>
    </main>

    <!-- Modal for forms -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Global configuration
        const API_BASE_URL = 'http://localhost:8080/pahanaeduapi/api';
        
        // Show API errors
        function showApiError(message) {
            const errorEl = document.getElementById('apiError');
            errorEl.textContent = `API Error: ${message}`;
            errorEl.style.display = 'block';
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        // Helper function for authenticated requests
        async function makeRequest(url, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            const token = localStorage.getItem('authToken');
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const config = {
                method,
                headers
            };
            
            if (body) {
                config.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${url}`, config);
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }
                
                return response.json();
            } catch (error) {
                showApiError(error.message);
                throw error;
            }
        }
    </script>
    
    <script src="js/auth.js"></script>
    <script src="js/customers.js"></script>
    <script src="js/bills.js"></script>
    <script src="js/items.js"></script>
    <script src="js/users.js"></script>
    
    <script>
        // Make core functions globally accessible
        window.loadCustomers = async function(searchTerm = '') {
            try {
                let url = '/customers';
                if (searchTerm) {
                    url += `?search=${encodeURIComponent(searchTerm)}`;
                }
                
                const customers = await makeRequest(url);
                
                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>Account #</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Units</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customers.map(customer => `
                                <tr>
                                    <td>${customer.accountNumber}</td>
                                    <td>${customer.name}</td>
                                    <td>${customer.email}</td>
                                    <td>${customer.telephone}</td>
                                    <td>${customer.unitsConsumed}</td>
                                    <td>
                                        <button class="action-btn edit-btn" onclick="editCustomer('${customer.accountNumber}')">Edit</button>
                                        <button class="action-btn delete-btn" onclick="deleteCustomer('${customer.accountNumber}')">Delete</button>
                                        <button class="action-btn view-btn" onclick="viewCustomerBills('${customer.accountNumber}')">Bills</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('customerList').innerHTML = table;
            } catch (error) {
                document.getElementById('customerList').innerHTML = '<p>Error loading customers. Please try again.</p>';
            }
        };

        window.loadBills = async function(accountNumber = '', status = 'all') {
            try {
                let url = '/bills';
                if (accountNumber) {
                    url = `/bills/account/${accountNumber}`;
                }
                
                const bills = await makeRequest(url);
                let filteredBills = bills;
                
                if (status !== 'all') {
                    filteredBills = bills.filter(bill => bill.paymentStatus === status);
                }
                
                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>Bill ID</th>
                                <th>Account #</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredBills.map(bill => `
                                <tr>
                                    <td>${bill.billId}</td>
                                    <td>${bill.accountNumber}</td>
                                    <td>${new Date(bill.billDate).toLocaleDateString()}</td>
                                    <td>$${bill.amountDue.toFixed(2)}</td>
                                    <td>${bill.paymentStatus}</td>
                                    <td>
                                        <button class="action-btn view-btn" onclick="viewBillDetails(${bill.billId})">View</button>
                                        ${bill.paymentStatus === 'PENDING' ? 
                                            `<button class="action-btn edit-btn" onclick="markBillAsPaid(${bill.billId})">Mark Paid</button>` : 
                                            ''
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('billList').innerHTML = table;
            } catch (error) {
                document.getElementById('billList').innerHTML = '<p>Error loading bills. Please try again.</p>';
            }
        };

        window.loadUsers = async function() {
            try {
                // Only allow admin to manage users
                if (localStorage.getItem('userRole') !== 'ADMIN') {
                    document.getElementById('users').innerHTML = `
                        <h2>Access Denied</h2>
                        <p>You don't have permission to access this section.</p>
                    `;
                    return;
                }
                
                const users = await makeRequest('/users');
                
                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>${user.userId}</td>
                                    <td>${user.username}</td>
                                    <td>${user.role}</td>
                                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                    <td>
                                        <button class="action-btn edit-btn" onclick="editUser(${user.userId})">Edit</button>
                                        <button class="action-btn delete-btn" onclick="deleteUser(${user.userId})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('userList').innerHTML = table;
            } catch (error) {
                document.getElementById('userList').innerHTML = '<p>Error loading users. Please try again.</p>';
            }
        };

        // Navigation between sections
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                
                // Update active state
                document.querySelectorAll('nav a').forEach(navLink => {
                    navLink.classList.remove('active');
                });
                link.classList.add('active');
                
                // Show the selected section
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(section).classList.add('active');
                
                // Load section data when clicked
                switch(section) {
                    case 'dashboard':
                        loadDashboardStats();
                        break;
                    case 'customers':
                        loadCustomers();
                        break;
                    case 'bills':
                        loadBills();
                        break;
                    case 'items':
                        // Items are handled in items.js
                        break;
                    case 'users':
                        loadUsers();
                        break;
                }
            });
        });

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('authToken')) {
                window.location.href = 'login.html';
            } else {
                // Load initial data
                loadDashboardStats();
                
                // Initialize event listeners
                initializeEventListeners();
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        });

        // Modal functionality
        const modal = document.getElementById('modal');
        const closeBtn = document.querySelector('.close');

        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        window.openModal = function(content) {
            document.getElementById('modalBody').innerHTML = content;
            modal.style.display = 'block';
        };

        // Initialize all event listeners
        function initializeEventListeners() {
            // Customers section
            document.getElementById('addCustomerBtn').addEventListener('click', () => {
                showCustomerForm();
            });
            
            document.getElementById('searchCustomerBtn').addEventListener('click', () => {
                const searchTerm = document.getElementById('customerSearch').value;
                loadCustomers(searchTerm);
            });

            // Bills section
            document.getElementById('generateBillBtn').addEventListener('click', () => {
                showGenerateBillForm();
            });
            
            document.getElementById('searchBillBtn').addEventListener('click', () => {
                const accountNumber = document.getElementById('billSearch').value;
                const status = document.getElementById('billStatusFilter').value;
                loadBills(accountNumber, status);
            });

            // Users section
            document.getElementById('addUserBtn').addEventListener('click', () => {
                showUserForm();
            });
        }

        async function loadDashboardStats() {
            try {
                // Fetch customers count
                const customers = await makeRequest('/customers');
                document.getElementById('totalCustomers').textContent = customers.length;
                
                // Fetch bills
                const bills = await makeRequest('/bills');
                
                const pending = bills.filter(bill => bill.paymentStatus === 'PENDING').length;
                const paid = bills.filter(bill => bill.paymentStatus === 'PAID').length;
                const revenue = bills.reduce((sum, bill) => sum + bill.amountDue, 0);
                
                document.getElementById('pendingBills').textContent = pending;
                document.getElementById('paidBills').textContent = paid;
                document.getElementById('totalRevenue').textContent = `$${revenue.toFixed(2)}`;
                
                // Recent activity
                const activity = bills.slice(0, 5).map(bill => 
                    `<div class="activity-item">
                        <span>Bill #${bill.billId} for ${bill.accountNumber}</span>
                        <span>$${bill.amountDue.toFixed(2)} - ${bill.paymentStatus}</span>
                    </div>`
                ).join('');
                document.getElementById('activityLog').innerHTML = activity;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                document.getElementById('activityLog').innerHTML = 
                    '<p>Error loading dashboard data. Please try again.</p>';
            }
        }
    </script>
</body>
</html>